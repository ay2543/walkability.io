---
title: "Statistical Analysis"
output: github_document
---

<style>
div.blue { background-color:aliceblue; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

##### On this page XXXXX

</div>

<br>


```{r setup, include=FALSE}
#install.packages("betareg")

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(modelr)
library(betareg)
library(mgcv)

dataset = read_csv("./data/merge_final.csv")
```

```{r pivot-dataset}
regress_df = dataset %>% 
  pivot_wider(names_from = "race",
               values_from = "percent_race") %>% 
  pivot_wider(names_from = "measure_id",
              values_from = "data_value") %>% 
  janitor::clean_names() %>% 
  select(tractce, nat_walk_ind, csa_name, lat, long, sex_male, sex_female, age_18plus, median_income, white, black, aian, asian, x2_plus, hispanic, highchol, mhlth, lpa, phlth, bphigh)
```


```{r beta-test-code}
test = regress_df %>% 
  filter(grepl('UT', csa_name)) %>% 
  mutate(
    sex_male = as.numeric(sex_male)/100,
    age_18plus = as.numeric(age_18plus)/100,
    white = as.numeric(white)/100,
    black = as.numeric(black)/100,
    aian = as.numeric(aian)/100,
    asian = as.numeric(asian)/100, 
    x2_plus = as.numeric(x2_plus)/100, 
    hispanic = as.numeric(hispanic)/100, 
    highchol = highchol/100, 
    mhlth = mhlth/100, 
    lpa = lpa/100, 
    phlth = phlth/100, 
    bphigh = bphigh/100,
    median_income = as.numeric(median_income)
    ) %>%
  group_by(tractce) %>% 
  summarize(
    nat_walk_tract = mean(nat_walk_ind),
    sex_male = mean(sex_male),
    age_18plus = mean(age_18plus),
    white = mean(white),
    black = mean(black),
    aian = mean(aian),
    asian = mean(asian), 
    x2_plus = mean(x2_plus), 
    hispanic = mean(hispanic), 
    highchol = mean(highchol), 
    mhlth = mean(mhlth), 
    lpa = mean(lpa), 
    phlth = mean(phlth), 
    bphigh = mean(bphigh),
    median_income = mean(median_income),
    lat = lat,
    long = long
    ) %>% 
  distinct(.keep_all = TRUE)

mod_ut <- gam(highchol ~ nat_walk_tract + sex_male + age_18plus + black + median_income + s(lat, long, bs="gp", m=2), 
           family = betar(link='logit'), 
           data = test)

summary(mod_ut)

mod_utbeta <- betareg(highchol ~ nat_walk_tract + sex_male + age_18plus + black + median_income, data = test)

summary(mod_utbeta)

residual1_plot =
    test %>%
    add_predictions(mod_utbeta) %>%
    add_residuals(mod_utbeta) %>%
    ggplot(aes(x = nat_walk_ind, y = resid)) +
    geom_point(alpha = 0.3, size = 0.3) +
    geom_smooth(se = FALSE, method = "lm")

residual1_plot

residual_plot =
    test %>%
    add_predictions(mod_ut) %>%
    add_residuals(mod_ut) %>%
    ggplot(aes(x = nat_walk_ind, y = resid)) +
    geom_point(alpha = 0.3, size = 0.3) +
    geom_smooth(se = FALSE, method = "lm")

residual_plot
```

```{r reference-code}
#baltimore_glm =
#  baltimore_df %>%
#  glm(solved ~ victim_age + victim_sex + victim_race,
#    data = .,
#    family = binomial()) %>%
#  broom::tidy() %>%
#  janitor::clean_names() %>%
#  mutate(OR = exp(estimate),
#         CI_lower = exp(estimate - 1.96*std_error),
#         CI_upper = exp(estimate + 1.96*std_error))
#baltimore_glm
```


