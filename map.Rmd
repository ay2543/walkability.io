---
title: "Interactive Map"
output: html_document
---

<style>
div.blue { background-color:aliceblue; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

##### On this page, we will explore the National Walkability Index across geographical regions in the United States. 
</div>


When your mouse hover onto a county, the textbox displays the county name, National Walkability Index, and health outcomes percentage. These health outcomes are:

* High Cholesterol: High cholesterol among adults aged >=18 years who have been screened in the past 5 years
* Physical Inactivity: No leisure-time physical activity among adults aged >=18 years
* Mental Health: Mental health not good for >=14 days among adults aged >=18 years
* Physical Health: Physical health not good for >=14 days among adults aged >=18 years
* High Blood Pressure: High blood pressure among adults aged >=18 years

You can also check out the interactive map showing the National Walkability Index published by the EPA [here](https://www.arcgis.com/home/webmap/viewer.html?url=https%3A%2F%2Fgeodata.epa.gov%2Farcgis%2Frest%2Fservices%2FOA%2FWalkabilityIndex%2FMapServer&source=sd).


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(rjson)
library(leaflet)
library(tidyverse)
library(plotly)

#Read in cleaned datafile

walkability = read_csv("./data/merge_final.csv")

#Get the county-level .json file from the web
url = 'https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json'

counties = rjson::fromJSON(file = url)

#Set up the geographic projection for the map 
g = list(scope = 'usa',
         projection = list(type = 'albers usa'))

#Get the df for mean of walkability index by county
index_by_county = walkability %>% 
  mutate(fips_county = str_c(statefp, countyfp)) %>% 
  group_by(fips_county) %>% 
  summarise(ind_mean = round(mean(nat_walk_ind), 1))

#Get the df for mean of health outcome prevalence by county
hover_test_df = walkability %>%
  mutate(fips_county = str_c(statefp, countyfp)) %>% 
  group_by(fips_county, measure_id) %>%
  summarise(county_hlth = round(mean(data_value, na.rm = TRUE), 1)) %>%
  pivot_wider(names_from = "measure_id", values_from = "county_hlth") %>% 
  janitor::clean_names()

#Merge the two df by county-level FIPS
walkability_map = full_join(x = index_by_county, y = hover_test_df, by = "fips_county")

#Adding variable for hovertext
walkability_map$hover <- with(walkability_map, 
                            paste('<br>',
                                  "National Walkability Index (by County):", ind_mean, '<br>', 
                                  "% Health Outcomes (by County)", '<br>',
                                  "High Cholesterol:", highchol, '<br>',
                                  "Physical Inactivity:", lpa, '<br>',
                                  "Mental Health:", mhlth, '<br>',
                                  "Physical Health:", phlth, '<br>',
                                  "High Blood Pressure:", bphigh))

#Choropleth with hovertext of health outcomes by county by plotly
choropleth_map = plot_ly()

choropleth_map = choropleth_map %>% 
  add_trace(type = "choropleth",
            geojson = counties,
            locations = walkability_map$fips_county,
            z = walkability_map$ind_mean,
            text = walkability_map$hover,
            colorscale = "Viridis",
            reversescale = T, #to get reverse color scheme
            zmin = 1,
            zmax = 16,
            marker = list(line = list(width = 0)))

choropleth_map = choropleth_map %>%
  layout(title = "National Walkability Index in the US")

choropleth_map = choropleth_map %>% 
  layout(geo = g)

choropleth_map
```


### Clustering analysis for walkability

```{r echo=FALSE, message=FALSE, warning=FALSE, results= FALSE}
library(rgeoda)
library(sf)
library(tmap)
library(tidyverse)
library(leaflet)


# Read-in csv
cluster_map <- st_read("./data/cluster_analysis/map_with_everything.shp", quiet = TRUE)

cluster_map_clean = cluster_map %>% 
  janitor::clean_names() %>% 
  mutate(nat_walk_i = as.numeric(nat_walk_i),
        nat_walk_i = round(nat_walk_i, digits = 1)) %>% 
  filter(stusps == "NY",
         namelsadco %in% c("Bronx County", "Kings County", "New York County", "Queens County", "Richmond County")) %>% 
  rename(median_income = s1903_c03) %>% 
  mutate(median_income = as.numeric(median_income))

cluster_map_NY = cluster_map_clean[!is.na(cluster_map_clean$nat_walk_i),]
  

# Queen 1st order weights matrix 
queen_w <- queen_weights(cluster_map_NY, order = 1)

#summary(queen_w)

# Local Moran's I
lisa <- local_moran(queen_w, cluster_map_NY["nat_walk_i"],
                    permutations = 9999)

# What's contained under the "lisa" object?
#names(lisa)


# Get cluster column and join it to zip shp
cluster_map_NY$cluster <- as.factor(lisa$GetClusterIndicators())
str(cluster_map_NY)

# Add labels to clusters
levels(cluster_map_NY$cluster) <- lisa$GetLabels()

# Map clusters
#tm_shape(cluster_map) +
#  tm_fill("cluster") 

# We need the GeoDa colors!
lisa_colors <- lisa_colors(lisa)

# Recode clusters using tidyverse (dyplr)
cluster_map_NY %>% 
  mutate(cluster = recode_factor(.x = cluster,
                                  `Undefined` = "Not significant",
                                  `Isolated` = "Not significant")) -> cluster_map_NY

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Map new categories 
tmap_mode("view")

tm_basemap("CartoDB.Positron") +
  tm_shape(cluster_map_NY) +
  tm_polygons(col = "cluster", 
              palette =  c("#eeeeee", 
                      "#FF0000",
                      "#0000FF",
                      "#a7adf9",
                      "#f4ada8"),
              alpha = .8,
              title = "Clusters",
              border.col = "black",
              border.alpha = .9) 
```

