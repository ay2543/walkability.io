---
title: "Interactive Map"
output: html_document
---

Enjoy our interactive map!

When your mouse hover onto a county, the textbox displays the county name, National Walkability Index, and health outcomes percentage. These health outcomes are:

* High Cholesterol: High cholesterol among adults aged >=18 years who have been screened in the past 5 years
* Physical Inactivity: No leisure-time physical activity among adults aged >=18 years
* Mental Health: Mental health not good for >=14 days among adults aged >=18 years
* Physical Health: Physical health not good for >=14 days among adults aged >=18 years
* High Blood Pressure: High blood pressure among adults aged >=18 years

You can also check out the interactive map showing the National Walkability Index published by the EPA [here](https://www.arcgis.com/home/webmap/viewer.html?url=https%3A%2F%2Fgeodata.epa.gov%2Farcgis%2Frest%2Fservices%2FOA%2FWalkabilityIndex%2FMapServer&source=sd).


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(rjson)
library(leaflet)
library(tidyverse)
library(plotly)

#Read in cleaned datafile

walkability = read_csv("./data/merge_final.csv")

#Get the county-level .json file from the web
url = 'https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json'

counties = rjson::fromJSON(file = url)

#Set up the geographic projection for the map 
g = list(scope = 'usa',
         projection = list(type = 'albers usa'))

#Get the df for mean of walkability index by county
index_by_county = walkability %>% 
  mutate(fips_county = str_c(statefp, countyfp)) %>% 
  group_by(fips_county) %>% 
  summarise(ind_mean = round(mean(nat_walk_ind), 1))

#Get the df for mean of health outcome prevalence by county
hover_test_df = walkability %>%
  mutate(fips_county = str_c(statefp, countyfp)) %>% 
  group_by(fips_county, measure_id) %>%
  summarise(county_hlth = round(mean(data_value, na.rm = TRUE), 1)) %>%
  pivot_wider(names_from = "measure_id", values_from = "county_hlth") %>% 
  janitor::clean_names()

#Merge the two df by county-level FIPS
walkability_plot = full_join(x = index_by_county, y = hover_test_df, by = "fips_county")

#Adding variable for hovertext
walkability_plot$hover <- with(walkability_plot, 
                            paste('<br>',
                                  "National Walkability Index (by County):", ind_mean, '<br>', 
                                  "% Health Outcomes (by County)", '<br>',
                                  "High Cholesterol:", highchol, '<br>',
                                  "Physical Inactivity:", lpa, '<br>',
                                  "Mental Health:", mhlth, '<br>',
                                  "Physical Health:", phlth, '<br>',
                                  "High Blood Pressure:", bphigh))

#Choropleth with hovertext of health outcomes by county by plotly
fig_hover_test = plot_ly()

fig_hover_test = fig_hover_test %>% 
  add_trace(type = "choropleth",
            geojson = counties,
            locations = walkability_plot$fips_county,
            z = walkability_plot$ind_mean,
            text = walkability_plot$hover,
            colorscale = "Viridis",
            reversescale = T, #to get reverse color scheme
            zmin = 1,
            zmax = 16,
            marker = list(line = list(width = 0)))

fig_hover_test = fig_hover_test %>%
  layout(title = "National Walkability Index in the US")

fig_hover_test = fig_hover_test %>% 
  layout(geo = g)

fig_hover_test
```

