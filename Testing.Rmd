---
title: "Testing"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)

```

## Walkability Data
```{r}
walkability_raw = read_csv("./data/EPA_SmartLocationDatabase_V3_Jan_2021_Final.csv")

walkability_new = walkability_raw %>% 
  janitor::clean_names() %>% 
  mutate(statefp = str_pad(statefp, width = 2, pad = "0"),
         countyfp = str_pad(countyfp, width = 3, pad = "0"),
         tractce = str_pad(tractce, width = 6, pad = "0"),
         fips = str_c(statefp, countyfp, tractce, blkgrpce, sep = "")) %>% 
  select(fips, everything(), -objectid)
  
walkability_clean = walkability_new %>% 
  select(fips, statefp, countyfp, tractce, blkgrpce, nat_walk_ind, csa_name) %>% 
  mutate(location_name = str_c(statefp, countyfp, tractce, sep = ""))
  
```

## Health Outcome Data - BRFSS

```{r}
# raw data with all health outcomes
health_df = read_csv("./data/PLACES__Local_Data_for_Better_Health__Census_Tract_Data_2022_release.csv")

health_new = health_df %>% 
  janitor::clean_names() %>%
  mutate(location_name = str_pad(location_name, width = 11, pad = "0"),
         geolocation = str_replace(geolocation, "^POINT ", ""),
         geolocation = str_replace(geolocation, "^\\(", ""),
         geolocation = str_replace(geolocation, "\\)$", "")) %>% 
  separate(geolocation, into = c("lat", "long"), sep = " ")
  
```

## Demographic Data - ACS 2020
### Age and Race
```{r}
demo_raw = read_csv("./data/ACSDP5Y2020.DP05-Data.csv")

demo_clean = demo_raw %>% 
  slice(-1) %>% 
  janitor::clean_names() %>%
  select(-ends_with(c("ea", "m", "ma"))) %>% 
  mutate(geo_clean = geo_id, 
         geo_clean = str_replace(geo_clean, "^1400000US", "")) %>% 
  select(geo_clean, everything())
```

### Median household income 
```{r}
income_raw = read_csv("./data/ACSST5Y2020.S1903-Data.csv")

income_clean = income_raw %>% 
  janitor::clean_names() %>%
  select(geo_id, name, s1903_c03_001e) %>% 
  slice(-1) %>% 
  mutate(geo_clean = geo_id, 
         geo_clean = str_replace(geo_clean, "^1400000US", "")) %>% 
  select(geo_clean, everything())
```


## Further cleaning
```{r}
# for health outcome, we are focusing on 5 outcomes that are likely to be related to walkability 

health_clean = health_new %>% 
  filter(measure_id == c("BPHIGH", "PHLTH", "LPA", "MHLTH", "HIGHCHOL")) %>% 
  select(location_name, lat, long, measure, data_value, data_value_type, data_value_unit, measure_id)
```


##Merge
```{r}
# merging walkability and health outcomes
merge1 = full_join(x = walkability_clean, y = health_clean, by = "location_name")

#mergeing demographic into one df - age&race + median household income
merge2 = full_join(demo_clean, income_clean, by = "geo_clean")
  
merge2 = merge2 %>% 
  mutate(location_name = geo_clean) 

# merge merge1 and merge2
merge_final = full_join(x = merge1, y = merge2, by = "location_name")

```

## Plot try
```{r}
merge_final %>%
  plot_ly(
    x = ~lat, y = ~long, type = "scatter", mode = "markers",
    color = ~nat_walk_ind, alpha = 0.5)
```


## Plot more and failed
```{r}
library(maptools)
library(spatstat)
library(sf)

map_try = st_read("./data/cb_2020_us_tract_500k/cb_2020_us_tract_500k.shp")

plot(map_try["geometry"])

map_window = as.owin(map_try)


map_try <- st_union(map_try)

map_try <- st_transform(map_try, crs = 6345)

window <- as.owin(map_try)

plot(window)

map_try = as_Spatial(map_try)
```

## Plot more and successed
```{r}
library(rjson)

walkability_plot = walkability_clean %>% 
  mutate(fips_county = str_c(statefp, countyfp)) %>% 
  group_by(fips_county) %>% 
  summarise(ind_mean = mean(nat_walk_ind))

url = 'https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json'

counties = rjson::fromJSON(file = url)

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

fig <- plot_ly()

fig <- fig %>% add_trace(
    type="choropleth",
    geojson=counties,
    locations=walkability_plot$fips_county,
    z=walkability_plot$ind_mean,
    colorscale="Viridis",
    zmin=0,
    zmax=12,
    marker=list(line=list(
      width=0)
    )
  )

fig <- fig %>% colorbar(title = "National Walkability Index")
fig <- fig %>% layout(
    title = "National Walkability Index in the US"
)

fig <- fig %>% layout(
    geo = g
  )

fig
```



